#!/usr/bin/env python3
"""Aina - CLI tool for managing code analysis sets."""
import argparse
import sys
from pathlib import Path

from aina_lib import cmd_list, cmd_remove, cmd_analyze, cmd_serve


def get_default_db_path():
    """Get default database path: ~/.aina/db.sqlite"""
    return str(Path.home() / '.aina' / 'db.sqlite')


def main():
    """Main entry point for aina CLI."""
    parser = argparse.ArgumentParser(
        description='Aina - Multi-repository code analysis',
        epilog='Use "aina <command> --help" for more information about a command.'
    )

    # Global options
    parser.add_argument(
        '--db',
        default=get_default_db_path(),
        help='Path to database file (default: ~/.aina/db.sqlite)'
    )

    # Subcommands
    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # Analyze command
    analyze_parser = subparsers.add_parser(
        'analyze',
        help='Analyze repositories and generate JSON output'
    )
    analyze_parser.add_argument('name', help='Name for the analysis set')
    analyze_parser.add_argument('path', nargs='?', help='Path to folder (required first time, remembered after)')

    # List command
    list_parser = subparsers.add_parser(
        'list',
        help='List all registered analysis sets'
    )

    # Remove command
    remove_parser = subparsers.add_parser(
        'remove',
        help='Remove an analysis set'
    )
    remove_parser.add_argument('name', help='Name of the analysis set to remove')

    # Serve command
    serve_parser = subparsers.add_parser(
        'serve',
        help='Serve the frontend and analysis data'
    )
    serve_parser.add_argument(
        '--port', '-p',
        type=int,
        default=8080,
        help='Port to serve on (default: 8080)'
    )
    serve_parser.add_argument(
        '--no-browser',
        action='store_true',
        help='Do not open browser automatically'
    )

    # Parse arguments
    args = parser.parse_args()

    # Handle commands
    if args.command == 'analyze':
        success = cmd_analyze(args.name, args.path, args.db)
        sys.exit(0 if success else 1)
    elif args.command == 'list':
        success = cmd_list(args.db)
        sys.exit(0 if success else 1)
    elif args.command == 'remove':
        success = cmd_remove(args.name, args.db)
        sys.exit(0 if success else 1)
    elif args.command == 'serve':
        success = cmd_serve(port=args.port, no_browser=args.no_browser)
        sys.exit(0 if success else 1)
    else:
        parser.print_help()
        sys.exit(1)


if __name__ == '__main__':
    main()
