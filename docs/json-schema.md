# Analysis JSON Schema

**Purpose:** Define the JSON structure generated by `aina analyze` and consumed by the Vue frontend.

**Version:** 1.0 (Draft)
**Last Updated:** 2025-11-21

---

## Schema Structure

The analysis output is a hierarchical tree structure representing:
- **Analysis set** (root)
  - **Repositories**
    - **Directories**
      - **Files**

### Node Types

**Branch Node** (directory/repo):
```json
{
  "name": "backend-api",
  "type": "directory",
  "path": "/Users/kjetil/projects/backend-api/src",
  "children": [...]
}
```

**Leaf Node** (file):
```json
{
  "name": "auth.py",
  "type": "file",
  "path": "/Users/kjetil/projects/backend-api/src/auth.py",
  "value": 1234,
  "language": "Python",
  "extension": ".py",
  "commits": {
    "total": 45,
    "last_3_months": 12,
    "last_commit_date": "2025-11-15T14:32:00Z",
    "last_commit_age_days": 6
  }
}
```

---

## Full Schema Example

```json
{
  "analysis_set": "my-backend-services",
  "generated_at": "2025-11-21T10:30:00Z",
  "stats": {
    "total_lines": 125430,
    "total_files": 287,
    "total_repos": 3,
    "languages": {
      "Python": 85000,
      "JavaScript": 30000,
      "TypeScript": 10430
    }
  },
  "tree": {
    "name": "my-backend-services",
    "type": "analysis_set",
    "children": [
      {
        "name": "backend-api",
        "type": "repository",
        "path": "/Users/kjetil/projects/backend-api",
        "children": [
          {
            "name": "src",
            "type": "directory",
            "path": "/Users/kjetil/projects/backend-api/src",
            "children": [
              {
                "name": "services",
                "type": "directory",
                "path": "/Users/kjetil/projects/backend-api/src/services",
                "children": [
                  {
                    "name": "auth.py",
                    "type": "file",
                    "path": "/Users/kjetil/projects/backend-api/src/services/auth.py",
                    "value": 1234,
                    "language": "Python",
                    "extension": ".py",
                    "commits": {
                      "total": 45,
                      "last_3_months": 12,
                      "last_commit_date": "2025-11-15T14:32:00Z",
                      "last_commit_age_days": 6
                    }
                  },
                  {
                    "name": "database.py",
                    "type": "file",
                    "path": "/Users/kjetil/projects/backend-api/src/services/database.py",
                    "value": 2100,
                    "language": "Python",
                    "extension": ".py",
                    "commits": {
                      "total": 78,
                      "last_3_months": 5,
                      "last_commit_date": "2025-10-20T09:15:00Z",
                      "last_commit_age_days": 32
                    }
                  }
                ]
              }
            ]
          },
          {
            "name": "tests",
            "type": "directory",
            "path": "/Users/kjetil/projects/backend-api/tests",
            "children": [
              {
                "name": "test_auth.py",
                "type": "file",
                "path": "/Users/kjetil/projects/backend-api/tests/test_auth.py",
                "value": 800,
                "language": "Python",
                "extension": ".py",
                "commits": {
                  "total": 23,
                  "last_3_months": 8,
                  "last_commit_date": "2025-11-18T16:45:00Z",
                  "last_commit_age_days": 3
                }
              }
            ]
          }
        ]
      },
      {
        "name": "frontend",
        "type": "repository",
        "path": "/Users/kjetil/projects/frontend",
        "children": [
          {
            "name": "components",
            "type": "directory",
            "path": "/Users/kjetil/projects/frontend/components",
            "children": [
              {
                "name": "Header.vue",
                "type": "file",
                "path": "/Users/kjetil/projects/frontend/components/Header.vue",
                "value": 450,
                "language": "Vue",
                "extension": ".vue",
                "commits": {
                  "total": 15,
                  "last_3_months": 2,
                  "last_commit_date": "2025-09-10T11:20:00Z",
                  "last_commit_age_days": 72
                }
              }
            ]
          }
        ]
      }
    ]
  }
}
```

---

## Field Definitions

### Root Object

| Field | Type | Description |
|-------|------|-------------|
| `analysis_set` | string | Name of the analysis set (from `aina add`) |
| `generated_at` | ISO 8601 timestamp | When analysis was run |
| `stats` | object | Aggregate statistics (total lines, files, repos, languages) |
| `tree` | object | Hierarchical tree structure (root node) |

### Node Object (Branch)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Node name (directory/repo name) |
| `type` | enum | Yes | `"analysis_set"`, `"repository"`, or `"directory"` |
| `path` | string | No | Absolute filesystem path (omit for analysis_set root) |
| `children` | array | Yes | Child nodes (directories or files) |

### Node Object (Leaf/File)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Filename with extension |
| `type` | enum | Yes | `"file"` |
| `path` | string | Yes | Absolute filesystem path |
| `value` | integer | Yes | Lines of code (from cloc) |
| `language` | string | Yes | Programming language (from cloc or extension mapping) |
| `extension` | string | Yes | File extension (e.g. ".py", ".js") |
| `commits` | object | Yes | Git commit metadata |

### Commits Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `total` | integer | Yes | Total commits touching this file (all time) |
| `last_3_months` | integer | Yes | Commits in last 90 days |
| `last_commit_date` | ISO 8601 timestamp | Yes | Date of most recent commit |
| `last_commit_age_days` | integer | Yes | Days since last commit (derived from `last_commit_date`) |

---

## Data Sources

### cloc Integration
```bash
cloc --json /path/to/repo
```

**cloc output provides:**
- Language detection
- Line counts (code, comment, blank)
- File counts per language

**We extract:**
- `value` (lines of code) - use `code` field from cloc
- `language` - map cloc language names to our schema

### Git Integration
```bash
# Total commits for a file
git log --oneline -- path/to/file.py | wc -l

# Commits in last 3 months
git log --oneline --since="3 months ago" -- path/to/file.py | wc -l

# Last commit date
git log -1 --format="%aI" -- path/to/file.py
```

**We extract:**
- `commits.total` - all-time commit count
- `commits.last_3_months` - recent activity indicator
- `commits.last_commit_date` - freshness indicator
- `commits.last_commit_age_days` - calculated from `last_commit_date`

### File Extension
- Parsed from filename using `pathlib.Path(name).suffix`
- Stored in `extension` field
- Used for language mapping if cloc doesn't provide it

---

## Language Mapping

If cloc doesn't recognize a file type, fall back to extension-based mapping:

| Extension | Language |
|-----------|----------|
| `.py` | Python |
| `.js` | JavaScript |
| `.ts` | TypeScript |
| `.vue` | Vue |
| `.jsx`, `.tsx` | React |
| `.go` | Go |
| `.rs` | Rust |
| `.java` | Java |
| `.rb` | Ruby |
| `.php` | PHP |
| `.c`, `.h` | C |
| `.cpp`, `.hpp` | C++ |
| `.cs` | C# |
| `.swift` | Swift |
| `.kt` | Kotlin |
| `.sh` | Shell |
| `.sql` | SQL |
| `.md` | Markdown |
| `.json` | JSON |
| `.yaml`, `.yml` | YAML |
| *(unknown)* | `"Unknown"` |

---

## Implementation Notes

### Backend (`aina analyze`)

1. **Discover repos** - Use `discover_repos()` from `aina_lib.py`
2. **For each repo:**
   - Run `cloc --json <repo-path>`
   - Parse cloc output
   - For each file in cloc results:
     - Get Git commit stats
     - Build file node with all attributes
3. **Build tree structure** - Aggregate files into directory hierarchy
4. **Calculate stats** - Total lines, file counts, language breakdown
5. **Write JSON** - Save to `~/.aina/analysis/<analysis-set>.json`

### Frontend (Vue)

- Load JSON via `fetch()` or direct import
- Pass `tree` to D3 treemap component
- Use `stats` for summary panel
- Use file attributes for tooltips, filtering, and future overlays

### Future Overlay Features

With this schema, we can later add overlays for:
- **Change frequency** - Color by `commits.last_3_months`
- **Staleness** - Color by `commits.last_commit_age_days`
- **Hotspots** - Color by `commits.total`
- **Language distribution** - Filter/group by `language`

---

## Versioning

Schema changes will be versioned. Future versions may add:
- Code Maat metrics (coupling, temporal coupling)
- Complexity metrics (cyclomatic complexity)
- Test coverage data
- Author/ownership metadata

For now, v1.0 focuses on basic code volume + Git commit metadata.
